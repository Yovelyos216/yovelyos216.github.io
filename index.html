<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>CPR Simulation Timer</title>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --color-primary: #208491;
            --color-primary-hover: #1a6a73;
            --color-primary-active: #155a63;
            --color-text: #1f2121;
            --color-text-secondary: #627c7f;
            --color-bg: #fcfcf9;
            --color-surface: #ffffff;
            --color-border: #e0e0dc;
            --color-error: #c0152f;
            --color-success: #208491;
        }

        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background-color: var(--color-bg); color: var(--color-text); line-height: 1.5; }
        body { padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }

        .screen { display: none; }
        .screen.active { display: block; }
        .start-screen, .timer-screen, .admin-screen { background: var(--color-surface); border-radius: 8px; padding: 40px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04); }

        .title { font-size: 28px; font-weight: 600; margin-bottom: 30px; text-align: center; color: var(--color-text); }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: var(--color-text); }
        .form-control { width: 100%; padding: 10px 12px; font-size: 14px; border: 1px solid var(--color-border); border-radius: 6px; background: var(--color-surface); color: var(--color-text); }
        .form-control:focus { outline: 2px solid var(--color-primary); outline-offset: 0; }

        .form-group-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 150ms; text-decoration: none; }
        .btn-primary { background: var(--color-primary); color: #ffffff; width: 100%; }
        .btn-primary:hover { background: var(--color-primary-hover); }
        .btn-secondary { background: #f5f5f5; color: var(--color-text); border: 1px solid var(--color-border); }
        .btn-secondary:hover { background: #efefef; }
        .btn-danger { background: var(--color-error); color: #ffffff; }
        .btn-danger:hover { background: #a01228; }

        .timer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--color-border); }
        .timer-info { font-size: 14px; color: var(--color-text-secondary); }
        .timer-display { font-size: 72px; font-weight: 600; color: var(--color-primary); font-family: 'Courier New', monospace; letter-spacing: 2px; }

        .actions-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: var(--color-surface); }
        .actions-table thead { background: #f9f9f7; border-bottom: 2px solid var(--color-border); }
        .actions-table th, .actions-table td { padding: 16px; text-align: left; }
        .actions-table th { font-weight: 600; font-size: 16px; color: var(--color-text); }
        .actions-table td { border-bottom: 1px solid var(--color-border); }
        .actions-table tr:last-child td { border-bottom: none; }

        .action-name { font-weight: 500; width: 60%; font-size: 24px; }
        .action-time { font-family: 'Courier New', monospace; font-weight: 600; font-size: 24px; color: var(--color-primary); width: 20%; text-align: center; }
        .action-button { width: 20%; text-align: center; }

        .btn-action { padding: 10px 16px; font-size: 14px; background: var(--color-primary); color: #ffffff; border: none; border-radius: 4px; cursor: pointer; }
        .btn-action:hover { background: var(--color-primary-hover); }
        .btn-action.recorded { background: var(--color-success); cursor: default; }
        .action-row-recorded .action-name { color: var(--color-text-secondary); }

        .controls { display: flex; gap: 10px; justify-content: center; margin-top: 30px; }
        .controls .btn { flex: 1; max-width: 200px; }

        .admin-login { max-width: 400px; margin: 0 auto; }
        .admin-content { display: none; }
        .admin-content.active { display: block; }

        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--color-border); flex-wrap: wrap; }
        .admin-tab { padding: 10px 15px; background: transparent; border: none; cursor: pointer; font-size: 14px; font-weight: 500; color: var(--color-text-secondary); border-bottom: 3px solid transparent; }
        .admin-tab.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }

        .admin-tab-content { display: none; }
        .admin-tab-content.active { display: block; }

        .action-list-item { display: flex; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f9f9f7; border-radius: 4px; }
        .action-list-item input { flex: 1; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 13px; }
        .action-list-item button { padding: 6px 12px; background: var(--color-error); color: #ffffff; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }

        .add-action { display: flex; gap: 10px; margin-top: 20px; }
        .add-action input { flex: 1; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 13px; }
        .add-action button { padding: 8px 16px; background: var(--color-primary); color: #ffffff; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500; }

        .simulations-list { margin-top: 20px; max-height: 600px; overflow-y: auto; }
        .simulation-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f7; border-radius: 4px; margin-bottom: 10px; border-left: 4px solid var(--color-primary); }
        .simulation-info { flex: 1; }
        .simulation-info-row { font-size: 13px; margin: 4px 0; }
        .simulation-info-label { font-weight: 500; color: var(--color-text-secondary); display: inline-block; width: 100px; }
        .simulation-actions { display: flex; gap: 8px; }
        .simulation-actions button { padding: 6px 12px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; }

        .btn-download { background: var(--color-primary); color: #ffffff; }
        .btn-download:hover { background: var(--color-primary-hover); }
        .btn-delete { background: var(--color-error); color: #ffffff; }
        .btn-delete:hover { background: #a01228; }

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--color-surface); border-radius: 8px; padding: 30px; max-width: 400px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); }
        .modal-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--color-text); }
        .modal-message { font-size: 14px; color: var(--color-text-secondary); margin-bottom: 20px; line-height: 1.6; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons button { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .modal-btn-confirm { background: var(--color-primary); color: #ffffff; }
        .modal-btn-confirm:hover { background: var(--color-primary-hover); }
        .modal-btn-cancel { background: #f5f5f5; color: var(--color-text); border: 1px solid var(--color-border); }

        .loading { text-align: center; color: var(--color-text-secondary); padding: 20px; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .start-screen, .timer-screen, .admin-screen { padding: 15px; }
            .title { font-size: 20px; margin-bottom: 20px; }
            .form-group-row { grid-template-columns: 1fr; }
            .timer-display { font-size: 32px; }
            .actions-table { font-size: 11px; }
            .actions-table th, .actions-table td { padding: 6px 4px; }
            .action-name { width: 55%; font-size: 14px; }
            .action-time { width: 20%; font-size: 12px; }
            .btn-action { padding: 4px 8px; font-size: 11px; width: 100%; }
            .simulation-item { flex-direction: column; align-items: flex-start; }
            .simulation-actions { width: 100%; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Start Screen -->
        <div id="startScreen" class="screen active">
            <div class="start-screen">
                <h1 class="title">CPR Simulation Timer</h1>

                <div class="form-group">
                    <label class="form-label">Select Role</label>
                    <select id="roleSelect" class="form-control">
                        <option value="">-- Choose Role --</option>
                        <option value="emergencyphysician">Emergency Physician</option>
                        <option value="nurseled">Nurse-Led</option>
                    </select>
                </div>

                <div id="arrestTypeGroup" class="form-group" style="display: none;">
                    <label class="form-label">Arrest Type</label>
                    <select id="arrestTypeSelect" class="form-control">
                        <option value="">-- Choose Arrest Type --</option>
                        <option value="vfpvt">VF/pVT</option>
                        <option value="asystolepea">Asystole/PEA</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Simulation Number</label>
                    <input type="text" id="simulationNumber" class="form-control" placeholder="e.g., SIM-001">
                </div>

                <button class="btn btn-primary" onclick="startSimulation()">Start CPR</button>

                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-secondary" onclick="showAdminLogin()" style="width: 200px;">Admin Access</button>
                </div>
            </div>
        </div>

        <!-- Timer Screen -->
        <div id="timerScreen" class="screen">
            <div class="timer-screen">
                <div class="timer-header">
                    <div>
                        <div class="timer-info">Simulation <strong id="displaySimNumber"></strong></div>
                        <div class="timer-info">Role <strong id="displayRole"></strong></div>
                    </div>
                    <div style="text-align: right;">
                        <div class="timer-display" id="timerDisplay">00:00</div>
                        <div class="timer-info">Elapsed Time</div>
                    </div>
                </div>

                <table class="actions-table">
                    <thead>
                        <tr>
                            <th class="action-name">Action</th>
                            <th class="action-time">Time (MM:SS)</th>
                            <th class="action-button">Record</th>
                        </tr>
                    </thead>
                    <tbody id="actionsTableBody"></tbody>
                </table>

                <div class="controls">
                    <button class="btn btn-primary" onclick="endSimulation()" style="max-width: none;">End Simulation</button>
                </div>
            </div>
        </div>

        <!-- Admin Screen -->
        <div id="adminScreen" class="screen">
            <div class="admin-screen">
                <div id="adminLogin" class="admin-login">
                    <h1 class="title">Admin Access</h1>
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="adminUsername" class="form-control" placeholder="Username">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="adminPassword" class="form-control" placeholder="Password">
                    </div>
                    <button class="btn btn-primary" onclick="adminLogin()">Login</button>
                    <button class="btn btn-secondary" onclick="backToStart()" style="margin-top: 10px;">Back</button>
                </div>

                <div id="adminContent" class="admin-content">
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="adminLogout()" style="width: 200px;">Logout</button>
                    </div>

                    <div class="admin-tabs">
                        <button class="admin-tab active" onclick="switchAdminTab('ep')">Emergency Physician</button>
                        <button class="admin-tab" onclick="switchAdminTab('nlvf')">Nurse-Led VF/pVT</button>
                        <button class="admin-tab" onclick="switchAdminTab('nlasy')">Nurse-Led Asystole/PEA</button>
                        <button class="admin-tab" onclick="switchAdminTab('completed')">Completed Simulations</button>
                    </div>

                    <div id="ep-tab" class="admin-tab-content active">
                        <h3 style="margin-top: 0;">Emergency Physician Actions</h3>
                        <div id="epActionsList" class="action-list"></div>
                        <div class="add-action">
                            <input type="text" id="epNewAction" placeholder="New action name">
                            <button onclick="addAction('ep')">Add</button>
                        </div>
                    </div>

                    <div id="nlvf-tab" class="admin-tab-content">
                        <h3 style="margin-top: 0;">Nurse-Led VF/pVT Actions</h3>
                        <div id="nlVfActionsList" class="action-list"></div>
                        <div class="add-action">
                            <input type="text" id="nlVfNewAction" placeholder="New action name">
                            <button onclick="addAction('nlvf')">Add</button>
                        </div>
                    </div>

                    <div id="nlasy-tab" class="admin-tab-content">
                        <h3 style="margin-top: 0;">Nurse-Led Asystole/PEA Actions</h3>
                        <div id="nlAsyActionsList" class="action-list"></div>
                        <div class="add-action">
                            <input type="text" id="nlAsyNewAction" placeholder="New action name">
                            <button onclick="addAction('nlasy')">Add</button>
                        </div>
                    </div>

                    <div id="completed-tab" class="admin-tab-content">
                        <h3 style="margin-top: 0;">Completed Simulations</h3>
                        <div id="completedSimsList" class="simulations-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Completion Modal -->
    <div id="completionModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Simulation Completed</h2>
            <p class="modal-message">Simulation saved to Firebase and CSV downloaded!</p>
            <div class="modal-buttons">
                <button class="modal-btn-confirm" onclick="returnToStart()">Return to Start</button>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Confirm Deletion</h2>
            <p class="modal-message">Are you sure? This cannot be undone.</p>
            <div class="modal-buttons">
                <button class="modal-btn-confirm" style="background: var(--color-error);" onclick="confirmDelete()">Delete</button>
                <button class="modal-btn-cancel" onclick="cancelDelete()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDaztu3wCMurx0vm7sCzY0YNwAlCwLbUEg",
            authDomain: "nurse-led-simulations.firebaseapp.com",
            projectId: "nurse-led-simulations",
            storageBucket: "nurse-led-simulations.firebasestorage.app",
            messagingSenderId: "898568404799",
            appId: "1:898568404799:web:bd383b026f469d96809d8a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const defaultActions = {
            emergencyphysician: [
                'Start chest compressions',
                'Attach defibrillator/monitor',
                'Rhythm diagnosis',
                'First shock',
                'Activate metronome',
                'Correct ineffective compressions',
                'Assign team member to IV/IO access',
                'Assign team member to medications',
                'Rhythm diagnosis 2',
                'Compress change 2',
                'Second shock',
                'Administer epinephrine 1',
                'Rhythm diagnosis 3',
                'Compress change 3',
                'Third shock',
                'Administer amiodarone 1',
                'Rhythm diagnosis 4',
                'Compress change 4',
                'Fourth shock',
                'Administer epinephrine 2',
                'Rhythm diagnosis 5',
                'Compress change 5',
                'Fifth shock',
                'Administer amiodarone 2'
            ],
            nurseledvfpvt: [
                'Start chest compressions',
                'Attach defibrillator/monitor',
                'Rhythm diagnosis',
                'First shock',
                'Activate metronome',
                'Correct ineffective compressions',
                'Assign team member to IV/IO access',
                'Assign team member to medications',
                'Rhythm diagnosis 2',
                'Compress change 2',
                'Second shock',
                'Administer epinephrine 1',
                'Rhythm diagnosis 3',
                'Compress change 3',
                'Third shock',
                'Administer amiodarone 1',
                'Rhythm diagnosis 4',
                'Compress change 4',
                'Fourth shock',
                'Administer epinephrine 2',
                'Rhythm diagnosis 5',
                'Compress change 5',
                'Fifth shock',
                'Administer amiodarone 2'
            ],
            nurseledasystolepea: [
                'Start chest compressions',
                'Attach defibrillator/monitor',
                'Rhythm diagnosis',
                'Activate metronome',
                'Correct ineffective compressions',
                'Assign team member to IV/IO access',
                'Assign team member to medications',
                'Rhythm diagnosis 2',
                'Compress change 2',
                'Administer epinephrine 1',
                'Rhythm diagnosis 3',
                'Compress change 3',
                'Rhythm diagnosis 4',
                'Compress change 4',
                'Administer epinephrine 2'
            ]
        };

        let currentState = {
            role: null,
            arrestType: null,
            simulationNumber: null,
            startTime: null,
            actionTimes: [],
            actions: []
        };

        let adminLoggedIn = false;
        let timerInterval = null;
        let deleteTargetId = null;

        function loadActions() {
            if (!localStorage.getItem('actionLists')) {
                localStorage.setItem('actionLists', JSON.stringify(defaultActions));
            }
        }

        function getActions(role, arrestType) {
            const stored = JSON.parse(localStorage.getItem('actionLists') || '{}');
            if (role === 'emergencyphysician') {
                return stored.emergencyphysician || defaultActions.emergencyphysician;
            } else if (role === 'nurseled') {
                if (arrestType === 'vfpvt') {
                    return stored.nurseledvfpvt || defaultActions.nurseledvfpvt;
                } else if (arrestType === 'asystolepea') {
                    return stored.nurseledasystolepea || defaultActions.nurseledasystolepea;
                }
            }
            return [];
        }

        function startSimulation() {
            const role = document.getElementById('roleSelect').value;
            const arrestType = document.getElementById('arrestTypeSelect').value;
            const simNumber = document.getElementById('simulationNumber').value;

            if (!role || (role === 'nurseled' && !arrestType) || !simNumber) {
                alert('Please fill all required fields');
                return;
            }

            currentState.role = role;
            currentState.arrestType = arrestType;
            currentState.simulationNumber = simNumber;
            currentState.startTime = Date.now();
            currentState.actionTimes = [];
            currentState.actions = getActions(role, arrestType);

            renderTimerScreen();
            switchScreen('timerScreen');
            startTimer();
        }

        function renderTimerScreen() {
            document.getElementById('displaySimNumber').textContent = currentState.simulationNumber;
            const roleDisplay = currentState.role === 'emergencyphysician' ? 'Emergency Physician' : `Nurse-Led ${currentState.arrestType === 'vfpvt' ? 'VF/pVT' : 'Asystole/PEA'}`;
            document.getElementById('displayRole').textContent = roleDisplay;

            const tbody = document.getElementById('actionsTableBody');
            tbody.innerHTML = '';

            currentState.actions.forEach((action, index) => {
                const tr = document.createElement('tr');
                tr.id = `action-row-${index}`;
                tr.innerHTML = `
                    <td class="action-name">${action}</td>
                    <td class="action-time"><span id="time-${index}">--:--</span></td>
                    <td class="action-button">
                        <button class="btn-action" id="btn-${index}" onclick="recordTime(${index})">Record</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - currentState.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timerDisplay').textContent = 
                    String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
            }, 100);
        }

        function recordTime(index) {
            const elapsed = Math.floor((Date.now() - currentState.startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const timeStr = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');

            currentState.actionTimes[index] = timeStr;
            document.getElementById(`time-${index}`).textContent = timeStr;
            document.getElementById(`btn-${index}`).textContent = 'Recorded';
            document.getElementById(`btn-${index}`).classList.add('recorded');
            document.getElementById(`btn-${index}`).disabled = true;
            document.getElementById(`action-row-${index}`).classList.add('action-row-recorded');
        }

        function endSimulation() {
            if (timerInterval) clearInterval(timerInterval);
            saveToFirebase();
            downloadCSV();
            showCompletionModal();
        }

        function saveToFirebase() {
            db.collection('simulations').add({
                simulationNumber: currentState.simulationNumber,
                role: currentState.role,
                arrestType: currentState.arrestType,
                date: new Date(),
                actions: currentState.actions,
                times: currentState.actionTimes
            }).catch(error => console.error('Firebase error:', error));
        }

        function downloadCSV() {
            const now = new Date();
            let csv = 'Simulation Number,Arrest Type,Date,Time\n';
            csv += `"${currentState.simulationNumber}","${currentState.arrestType || 'N/A'}","${now.toLocaleDateString()}","${now.toLocaleTimeString()}"\n\n`;
            csv += 'Action,Time (MM:SS)\n';

            currentState.actions.forEach((action, index) => {
                const time = currentState.actionTimes[index] || '--:--';
                csv += `"${action}","${time}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CPRSimulation_${currentState.simulationNumber}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function showCompletionModal() {
            document.getElementById('completionModal').classList.add('active');
        }

        function returnToStart() {
            document.getElementById('completionModal').classList.remove('active');
            switchScreen('startScreen');
            document.getElementById('roleSelect').value = '';
            document.getElementById('arrestTypeSelect').value = '';
            document.getElementById('simulationNumber').value = '';
            document.getElementById('arrestTypeGroup').style.display = 'none';
        }

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function backToStart() {
            if (timerInterval) clearInterval(timerInterval);
            switchScreen('startScreen');
        }

        function showAdminLogin() {
            switchScreen('adminScreen');
            document.getElementById('adminLogin').style.display = 'block';
            document.getElementById('adminContent').classList.remove('active');
        }

        function adminLogin() {
            if (document.getElementById('adminUsername').value === 'yovelyos' && 
                document.getElementById('adminPassword').value === 'Yovel216') {
                adminLoggedIn = true;
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminContent').classList.add('active');
                renderAdminTabs();
                loadCompletedSimulations();
            } else {
                alert('Invalid credentials');
            }
        }

        function adminLogout() {
            adminLoggedIn = false;
            showAdminLogin();
        }

        function renderAdminTabs() {
            const tabs = {
                ep: { key: 'emergencyphysician', id: 'epActionsList' },
                nlvf: { key: 'nurseledvfpvt', id: 'nlVfActionsList' },
                nlasy: { key: 'nurseledasystolepea', id: 'nlAsyActionsList' }
            };

            Object.entries(tabs).forEach(([_, {key, id}]) => {
                const stored = JSON.parse(localStorage.getItem('actionLists') || '{}');
                const actions = stored[key] || defaultActions[key];
                const container = document.getElementById(id);
                container.innerHTML = '';

                actions.forEach((action, idx) => {
                    const item = document.createElement('div');
                    item.className = 'action-list-item';
                    item.innerHTML = `
                        <input type="text" value="${action}" onchange="updateAction('${key}', ${idx}, this.value)">
                        <button onclick="deleteAction('${key}', ${idx})">Delete</button>
                    `;
                    container.appendChild(item);
                });
            });
        }

        function loadCompletedSimulations() {
            const container = document.getElementById('completedSimsList');
            container.innerHTML = '<div class="loading">Loading simulations from Firebase...</div>';

            db.collection('simulations').orderBy('date', 'desc').get().then(querySnapshot => {
                container.innerHTML = '';
                if (querySnapshot.empty) {
                    container.innerHTML = '<p style="color: var(--color-text-secondary);">No completed simulations yet.</p>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const sim = doc.data();
                    const item = document.createElement('div');
                    item.className = 'simulation-item';
                    item.innerHTML = `
                        <div class="simulation-info">
                            <div class="simulation-info-row"><span class="simulation-info-label">Simulation:</span> <strong>${sim.simulationNumber}</strong></div>
                            <div class="simulation-info-row"><span class="simulation-info-label">Role:</span> ${sim.role === 'emergencyphysician' ? 'Emergency Physician' : `Nurse-Led ${sim.arrestType === 'vfpvt' ? 'VF/pVT' : 'Asystole/PEA'}`}</div>
                            <div class="simulation-info-row"><span class="simulation-info-label">Date:</span> ${sim.date.toDate().toLocaleDateString()}</div>
                        </div>
                        <div class="simulation-actions">
                            <button class="btn-download" onclick="downloadSimulationCSV('${JSON.stringify(sim).replace(/"/g, '&quot;')}')">Download CSV</button>
                            <button class="btn-delete" onclick="showDeleteConfirm('${doc.id}')">Delete</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }).catch(error => {
                container.innerHTML = '<p style="color: var(--color-error);">Error loading simulations</p>';
                console.error('Error:', error);
            });
        }

        function downloadSimulationCSV(simData) {
            const sim = JSON.parse(simData.replace(/&quot;/g, '"'));
            const date = sim.date.toDate ? sim.date.toDate() : new Date(sim.date);
            
            let csv = 'Simulation Number,Arrest Type,Date,Time\n';
            csv += `"${sim.simulationNumber}","${sim.arrestType || 'N/A'}","${date.toLocaleDateString()}","${date.toLocaleTimeString()}"\n\n`;
            csv += 'Action,Time (MM:SS)\n';

            sim.actions.forEach((action, idx) => {
                const time = sim.times[idx] || '--:--';
                csv += `"${action}","${time}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CPRSimulation_${sim.simulationNumber}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        let deleteTargetDocId = null;
        function showDeleteConfirm(docId) {
            deleteTargetDocId = docId;
            document.getElementById('deleteModal').classList.add('active');
        }

        function cancelDelete() {
            deleteTargetDocId = null;
            document.getElementById('deleteModal').classList.remove('active');
        }

        function confirmDelete() {
            if (!deleteTargetDocId) return;
            db.collection('simulations').doc(deleteTargetDocId).delete().then(() => {
                document.getElementById('deleteModal').classList.remove('active');
                loadCompletedSimulations();
            }).catch(error => console.error('Error deleting:', error));
        }

        function updateAction(key, idx, value) {
            const stored = JSON.parse(localStorage.getItem('actionLists') || '{}');
            if (!stored[key]) stored[key] = defaultActions[key];
            stored[key][idx] = value;
            localStorage.setItem('actionLists', JSON.stringify(stored));
            renderAdminTabs();
        }

        function deleteAction(key, idx) {
            const stored = JSON.parse(localStorage.getItem('actionLists') || '{}');
            if (!stored[key]) stored[key] = defaultActions[key];
            stored[key].splice(idx, 1);
            localStorage.setItem('actionLists', JSON.stringify(stored));
            renderAdminTabs();
        }

        function addAction(tabKey) {
            const keyMap = {ep: 'emergencyphysician', nlvf: 'nurseledvfpvt', nlasy: 'nurseledasystolepea'};
            const key = keyMap[tabKey];
            const inputId = tabKey === 'ep' ? 'epNewAction' : tabKey === 'nlvf' ? 'nlVfNewAction' : 'nlAsyNewAction';
            const value = document.getElementById(inputId).value.trim();

            if (!value) {
                alert('Please enter action name');
                return;
            }

            const stored = JSON.parse(localStorage.getItem('actionLists') || '{}');
            if (!stored[key]) stored[key] = defaultActions[key];
            stored[key].push(value);
            localStorage.setItem('actionLists', JSON.stringify(stored));
            document.getElementById(inputId).value = '';
            renderAdminTabs();
        }

        function switchAdminTab(tabKey) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${tabKey}-tab`).classList.add('active');
            if (tabKey === 'completed') loadCompletedSimulations();
        }

        document.getElementById('roleSelect').addEventListener('change', function() {
            const arrestTypeGroup = document.getElementById('arrestTypeGroup');
            arrestTypeGroup.style.display = this.value === 'nurseled' ? 'block' : 'none';
        });

        loadActions();
    </script>
</body>
</html>
